<!doctype html>
<html lang="zh-tw">
  <head>
  <meta charset="utf-8">
<title>PubSub Local Emulator - Blackdiz&#39;s Garage</title>
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="generator" content="Hugo 0.87.0" /><meta property="og:site_name" content="Blackdiz&#39;s Garage">
  <meta property="og:title" content="PubSub Local Emulator">
  <meta property="og:description" content="充滿各種小雜記的小車庫">
  <meta property="description" content="充滿各種小雜記的小車庫">
  <meta property="og:url" content="https://blackdiz.github.io/blog/pubsub-local-emulator/">
  <meta property="og:type" content="article">
  
    <meta property="og:image" content="https://blackdiz.github.io/img/main/logo.jpg">
  
  
            <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/styles/atom-one-dark.min.css">
          <link rel="stylesheet" href="/css/bundle.min.1bfccf86359e3de974865922b006112447a52f942c2a9c2bf93d159980ae641b.css" integrity="sha256-G/zPhjWePel0hlkisAYRJEelL5QsKpwr&#43;T0VmYCuZBs="><link rel="stylesheet" href="/css/add-on.css">
</head>

  <body>
    

<header id="site-header">
  <nav id="site-nav">
    <h1 class="nav-title">
      <a href="/" class="nav">
        
          部落格
        
      </a>
    </h1>
    <menu id="site-nav-menu" class="flyout-menu menu">
      
        
          
          <a href="/" class="nav link"><i class='fa fa-home'></i> Home</a>
        
      
        
          
          <a href="/about/" class="nav link"><i class='far fa-id-card'></i> About</a>
        
      
        
          
          <a href="/blog/" class="nav link"><i class='far fa-newspaper'></i> Blog</a>
        
      
        
          
          <a href="/categories/" class="nav link"><i class='fas fa-sitemap'></i> Categories</a>
        
      
      <a href="#share-menu" class="nav link share-toggle"><i class="fas fa-share-alt">&nbsp;</i>Share</a>
      <a href="#search-input" class="nav link search-toggle"><i class="fas fa-search">&nbsp;</i>Search</a>
    </menu>
    <a href="#search-input" class="nav search-toggle"><i class="fas fa-search fa-2x">&nbsp;</i></a>
    <a href="#share-menu" class="nav share-toggle"><i class="fas fa-share-alt fa-2x">&nbsp;</i></a>
    <a href="#lang-menu" class="nav lang-toggle" lang="zh-tw">zh-tw</a>
    <a href="#site-nav" class="nav nav-toggle"><i class="fas fa-bars fa-2x"></i></a>
  </nav>
  <menu id="search" class="menu"><input id="search-input" class="search-input menu"></input><div id="search-results" class="search-results menu"></div></menu>
  <menu id="lang-menu" class="flyout-menu menu">
  <a href="#" lang="zh-tw" class="nav link active">中文 (zh-tw)</a>
  
    
      
    
  
</menu>

  
    <menu id="share-menu" class="flyout-menu menu">
      <h1>Share Post</h1>
      




  
        <a href="mailto:?subject=%e6%9f%a5%e7%9c%8b%e6%ad%a4%e5%b8%96%e5%ad%90%e7%9a%84%e4%bd%9c%e8%80%85 %7b%20%20%20%20%20%20%20%20map%5b%5d%7d&amp;body=https%3a%2f%2fblackdiz.github.io%2fblog%2fpubsub-local-emulator%2f" target="_blank" class="nav share-btn email" data-proofer-ignore>
          <p>Email</p>
        </a>
  


    </menu>
  
</header>

    <div id="wrapper">
      <section id="site-intro" >
  <a href="/"><img src="https://blackdiz.github.io/img/main/logo.jpg" class="circle" width="100" alt="Hugo Future Imperfect Slim" /></a>
  <header>
    <h1>Blackdiz's Garage</h1>
  </header>
  <main>
    <p>心得、筆記、雜記</p>
  </main>
  
    <footer>
      <ul class="socnet-icons">
        

        <li><a href="//github.com/blackdiz" target="_blank" rel="noopener" title="GitHub" class="fab fa-github"></a></li>







































<li><a href="mailto:blackdiz@gmail.com" target="_blank" title="Email" class="far fa-envelope"></a></li>

      </ul>
    </footer>
  
</section>

      <main id="site-main">
        
  <article class="post">
    <header>
  <div class="title">
    
      <h2><a href="/blog/pubsub-local-emulator/">PubSub Local Emulator</a></h2>
    
    
  </div>
  <div class="meta">
    <time datetime="2021-08-26 23:38:30 &#43;0800 &#43;0800">August 26, 2021</time>
    
    <p>1 分鐘</p>
  </div>
</header>

    <div id="socnet-share">
      




  
        <a href="mailto:?subject=%e6%9f%a5%e7%9c%8b%e6%ad%a4%e5%b8%96%e5%ad%90%e7%9a%84%e4%bd%9c%e8%80%85 %7b%20%20%20%20%20%20%20%20map%5b%5d%7d&amp;body=https%3a%2f%2fblackdiz.github.io%2fblog%2fpubsub-local-emulator%2f" target="_blank" class="nav share-btn email" data-proofer-ignore>
          <p>Email</p>
        </a>
  


    </div>
    <div class="content">
      
      <p>PubSub 是 GCP 上類似 Message Queue 的服務，為了測試方便，Google 提供了可在本機端啟動的模擬程式讓開發者可以不用連上 GCP 直接使用本機的 PubSub service。</p>
<p>這篇算是記錄一下整個安裝過程和使用 Java 程式連接本機 PubSub 的程式片段。</p>
<h3 id="安裝-google-cloud-sdk">安裝 Google Cloud SDK</h3>
<p>首先需要安裝 Google Cloud SDK，目前只有在 MAC 上安裝，所以下面只簡單記錄一下 MAC 下的安裝步驟，其他環境可以到 <a href="https://cloud.google.com/sdk/docs/install">Google Cloud SDK Guide</a> 有詳細的說明。</p>
<p>如果 Mac 是 M1 版本下載 <a href="https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-354.0.0-darwin-arm.tar.gz">google-cloud-sdk-354.0.0-darwin-arm.tar.gz</a>，非 M1 則下載 <a href="https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-354.0.0-darwin-x86_64.tar.gz">google-cloud-sdk-354.0.0-darwin-x86_64.tar.gz</a>，解壓縮後執行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./google-cloud-sdk/install.sh <span style="color:#f92672">&amp;&amp;</span> ./google-cloud-sdk/bin/gcloud init
</code></pre></div><h3 id="安裝-pubsub-emulator">安裝 PubSub emulator</h3>
<p>執行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gcloud components install pubsub-emulator
gcloud components update
</code></pre></div><h3 id="啟動-pubsub-emulator">啟動 PubSub emulator</h3>
<p>執行，<code>PUBSUB_PROJECT_ID</code> 可以自由命名，在後面連線到 PubSub 時會用到。另外 PubSub 每次啟動時的 listen port 是隨機的，為了方便起見，我們用 <code>--host-port=0.0.0.0:8085</code> 指定 listen port 為 8085：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gcloud beta emulators pubsub start --host-port<span style="color:#f92672">=</span>0.0.0.0:8085 --project<span style="color:#f92672">=</span>PUBSUB_PROJECT_ID
</code></pre></div><p>接著設定環境變數 <code>PUBSUB_EMULATOR_HOST</code>，執行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#66d9ef">$(</span>gcloud beta emulators pubsub env-init<span style="color:#66d9ef">)</span>
</code></pre></div><p>會自動取得 PubSub 啟動時的 listen port 設為環境變數。</p>
<p>這邊為了方便寫了簡單的 script 一次做完並將 PubSub 的 log 輸出到檔案中：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/sh
</span><span style="color:#75715e"></span>gcloud beta emulators pubsub start --host-port<span style="color:#f92672">=</span>0.0.0.0:8085 --project<span style="color:#f92672">=</span>PUBSUB_PROJECT_ID 2&amp;1&gt; ~/pubsub.log
echo <span style="color:#e6db74">&#34;Set PUBSUB_EMULATOR_HOST&#34;</span>
<span style="color:#75715e"># 這裡不確定原因但用 $(gcloud beta emulators pubsub env-init) 無法正常設置環境變數。因為我們已經指定了 listen port，所以直接用 export 指定即可</span>
export PUBSUB_EMULATOR_HOST<span style="color:#f92672">=</span>0.0.0.0:8085
</code></pre></div>
    </div>
    <footer>
      <div class="stats">
  
    <ul class="categories">
      <li>None</li>
    </ul>
  
  
    <ul class="tags">
      <li>None</li>
    </ul>
  
</div>

    </footer>
  </article>
  
    

  
  <div class="pagination">
    
    
      <a href="/blog/higher-order-function/" class="button right"><span>Higher Order Function 小記</span></a>
    
  </div>

      </main>
      <section id="site-sidebar">
  
    <section id="recent-posts">
      <header>
        <h1>最新文章</h1>
      </header>
      
      <article class="mini-post">
          
        <header>
          <h2><a href="/blog/pubsub-local-emulator/">PubSub Local Emulator</a></h2>
          <time class="published" datetime="2021-08-26 23:38:30 &#43;0800 &#43;0800">August 26, 2021</time>
        </header>
      </article>
      
      <article class="mini-post">
          
        <header>
          <h2><a href="/blog/higher-order-function/">Higher Order Function 小記</a></h2>
          <time class="published" datetime="2021-08-14 22:35:07 &#43;0800 &#43;0800">August 14, 2021</time>
        </header>
      </article>
      
      <article class="mini-post">
          
        <header>
          <h2><a href="/blog/two-sum/">LeetCode 1. Two Sum</a></h2>
          <time class="published" datetime="2020-12-01 23:10:57 &#43;0800 &#43;0800">December 1, 2020</time>
        </header>
      </article>
      
      
    </section>
  

  
    

      <section id="categories">
        <header>
          <h1><a href="/categories">分類</a></h1>
        </header>
        <ul>
          
          
          <li>
              <a href="/categories/algorithm/">algorithm<span class="count">1</span></a>
          
          <li>
              <a href="/categories/note/">note<span class="count">1</span></a>
          
          </li>
        </ul>
      </section>
    
  

  
    <section id="mini-bio">
      <header>
        <h1>關於</h1>
      </header>
      <p>I'm so weak, so I follow every masters for learning anything I don't know.</p>
      <footer>
        <a href="/about" class="button">學到更多</a>
      </footer>
    </section>
  
</section>

      <footer id="site-footer">
  
      <ul class="socnet-icons">
        

        <li><a href="//github.com/blackdiz" target="_blank" rel="noopener" title="GitHub" class="fab fa-github"></a></li>







































<li><a href="mailto:blackdiz@gmail.com" target="_blank" title="Email" class="far fa-envelope"></a></li>

      </ul>
  
  <p class="copyright">
    © 2021 Blackdiz&#39;s Garage
      <br>
    主題: <a href='https://themes.gohugo.io/hugo-future-imperfect-slim/' target='_blank' rel='noopener'>Hugo Future Imperfect Slim</a><br>移植自 <a href='https://html5up.net/future-imperfect' target='_blank' rel='noopener'>HTML5 UP</a> | 由 <a href='https://gohugo.io/' target='_blank' rel='noopener' title='0.87.0'>Hugo</a> 提供
  </p>
</footer>
<a id="back-to-top" href="#" class="fas fa-arrow-up fa-2x"></a>

      <script src="/js/highlight.js"></script>
    
    <script>hljs.initHighlightingOnLoad();</script><script src="/js/bundle.min.ccb4e6bb4674f9a0e2b6ce56bb0cddea093526d4bc032314766519cdfec730b1.js" integrity="sha256-zLTmu0Z0&#43;aDits5Wuwzd6gk1JtS8AyMUdmUZzf7HMLE="></script>
    <script src="/js/add-on.js"></script>
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
<script type="text/javascript">
const delimiters = {
    "delimiters":[
        {left: "$$", right: "$$", display: true},
        {left: "$", right: "$", display: false},
    ]
};
</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"
    onload="renderMathInElement(document.body,delimiters);"></script>
      
    </div>
  </body>
</html>
