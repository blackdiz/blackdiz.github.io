<!doctype html><html lang=zh-tw><head><meta charset=utf-8><title>H2 Database and SQL Alias Column Name - Blackdiz's Garage</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=google-site-verification content="Dz97mIdDkadVEVU8hmTHqjtAcIFza455i8wijgkzBYA"><meta name=generator content="Hugo 0.83.1"><meta property="og:site_name" content="Blackdiz's Garage"><meta property="og:title" content="H2 Database and SQL Alias Column Name"><meta property="og:description" content="充滿各種小雜記的小車庫"><meta property="description" content="充滿各種小雜記的小車庫"><meta property="og:url" content="https://blackdiz.github.io/blog/sql-and-h2-db/"><meta property="og:type" content="article"><meta property="og:image" content="https://blackdiz.github.io/img/main/logo.jpg"><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/atom-one-dark.min.css><link rel=stylesheet href=/css/bundle.min.2b4e36cd6a81be0237f8d8f3ce0d239eb39d356f5e3b6c33140b8108476a2beb.css integrity="sha256-K042zWqBvgI3+Njzzg0jnrOdNW9eO2wzFAuBCEdqK+s="><link rel=stylesheet href=/css/add-on.css></head><body><header id=site-header><nav id=site-nav><h1 class=nav-title><a href=/ class=nav>部落格</a></h1><menu id=site-nav-menu class="flyout-menu menu"><a href=/ class="nav link"><i class="fa fa-home"></i> Home</a>
<a href=/blog/ class="nav link"><i class="far fa-newspaper"></i> Blog</a>
<a href=/categories/ class="nav link"><i class="fas fa-sitemap"></i> Categories</a>
<a href=/about/ class="nav link"><i class="far fa-id-card"></i> About</a>
<a href=#share-menu class="nav link share-toggle"><i class="fas fa-share-alt">&nbsp;</i>Share</a>
<a href=#search-input class="nav link search-toggle"><i class="fas fa-search">&nbsp;</i>Search</a></menu>
<a href=#search-input class="nav search-toggle"><i class="fas fa-search fa-2x">&nbsp;</i></a>
<a href=#share-menu class="nav share-toggle"><i class="fas fa-share-alt fa-2x">&nbsp;</i></a>
<a href=#lang-menu class="nav lang-toggle" lang=zh-tw>zh-tw</a>
<a href=#site-nav class="nav nav-toggle"><i class="fas fa-bars fa-2x"></i></a></nav><menu id=search class=menu><input id=search-input class="search-input menu"></input><div id=search-results class="search-results menu"></div></menu><menu id=lang-menu class="flyout-menu menu"><a href=# lang=zh-tw class="nav link active">中文 (zh-tw)</a></menu>
<menu id=share-menu class="flyout-menu menu"><h1>Share Post</h1></menu></header><div id=wrapper><section id=site-intro><a href=/><img src=https://blackdiz.github.io/img/main/logo.jpg class=circle width=100 alt="Hugo Future Imperfect Slim"></a><header><h1>Blackdiz's Garage</h1></header><main><p>心得、筆記、雜記</p></main><footer><ul class=socnet-icons><li><a href=//github.com/blackdiz target=_blank rel=noopener title=GitHub class="fab fa-github"></a></li><li><a href=mailto:blackdiz@gmail.com target=_blank title=Email class="far fa-envelope"></a></li></ul></footer></section><main id=site-main><article><div class=post><header><div class=title><h2><a href=/blog/sql-and-h2-db/>H2 Database and SQL Alias Column Name</a></h2></div><div class=meta><time datetime="2021-06-08 07:59:46 +0800 +0800">June 8, 2021</time><p>2 分鐘</p></div></header><div id=socnet-share></div><div class=content><p>朋友問了一個奇妙的狀況，下面這個 Spring JPA 的 NativeQuery 回傳的 column name 應該是 <code>as</code> 之後的名稱 (以下為測試的 NativeQuery，非朋友實際執行的 SQL)：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>String sql <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;select Name as Name, SeqNo as SeqNo from Test where Name = :name&#34;</span><span style=color:#f92672>;</span>
    List<span style=color:#f92672>&lt;</span>Tuple<span style=color:#f92672>&gt;</span> result <span style=color:#f92672>=</span> entityManager<span style=color:#f92672>.</span><span style=color:#a6e22e>createNativeQuery</span><span style=color:#f92672>(</span>sql<span style=color:#f92672>,</span> Tuple<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>).</span><span style=color:#a6e22e>setParameter</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;name&#34;</span><span style=color:#f92672>,</span> name<span style=color:#f92672>)</span>
      <span style=color:#f92672>.</span><span style=color:#a6e22e>getResultList</span><span style=color:#f92672>();</span>

    <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</code></pre></div><p>也就是 <code>Name</code> 和 <code>SeqNo</code>，但跑出來的結果卻是全大寫的 <code>NAME</code> 和 <code>SEQNO</code>：</p><p><img src=../../img/blog/wWBWDDJ.png alt></p><p>而且我使用 SQLServer 測試時無法重現這個狀況。一開始以為是不是 Spring JPA 的設定問題，但 Google 大神沒有降什麼神旨，翻了 Spring JPA 的文件也沒看到什麼相關的設定，想說只好用 debug 模式來追蹤一下到底執行過程中是不是有什麼地方會去修改 alias column name。
在追蹤的過程中，突然看到這行：</p><p><img src=../../img/blog/rP3ufx3.png alt>
雖然和執行過程無關 😅，但 <code>factory.getJdbcServices().getDialect()</code> 讓我想到朋友用的是 H2 Database，馬上去官網查了一下發現果然是因為 H2 預設對於沒有使用 <code>""</code> 括起來的欄位名稱都會依設定轉成全大寫或全小寫：</p><blockquote><h3 id=name>Name</h3><p>With default settings unquoted names are converted to upper case. There is no maximum name length.</p><p>Identifiers in H2 are case sensitive by default. Because unquoted names are converted to upper case, they can be written in any case anyway. When both quoted and unquoted names are used for the same identifier the quoted names must be written in upper case. Identifiers with lowercase characters can be written only as a quoted name, they aren&rsquo;t accessible with unquoted names.</p><p>If <code>DATABASE_TO_UPPER</code> setting is set to <code>FALSE</code> the unquoted names aren&rsquo;t converted to upper case.</p><p>If <code>DATABASE_TO_LOWER</code> setting is set to <code>TRUE</code> the unquoted names are converted to lower case instead.</p><p>If <code>CASE_INSENSITIVE_IDENTIFIERS</code> setting is set to <code>TRUE</code> all identifiers are case insensitive.</p></blockquote><p>所以如果要保持 SQL 中的大小寫必須用 <code>""</code> 括起來：</p><blockquote><h3 id=quoted-name>Quoted Name</h3><p>| <code>" anything "</code> |</p><p>Case of characters in quoted names is preserved as is. Such names can contain spaces. There is no maximum name length. Two double quotes can be used to create a single double quote inside an identifier. With default settings identifiers in H2 are case sensitive.</p><p>Example:</p><p>&ldquo;FirstName&rdquo;</p></blockquote><p>因此如果上面的 NativeQuery 改寫成：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>String sql <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;select Name as \&#34;Name\&#34;, SeqNo as \&#34;SeqNo\&#34; from Test where Name = :name&#34;</span><span style=color:#f92672>;</span>
    List<span style=color:#f92672>&lt;</span>Tuple<span style=color:#f92672>&gt;</span> result <span style=color:#f92672>=</span> entityManager<span style=color:#f92672>.</span><span style=color:#a6e22e>createNativeQuery</span><span style=color:#f92672>(</span>sql<span style=color:#f92672>,</span> Tuple<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>).</span><span style=color:#a6e22e>setParameter</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;name&#34;</span><span style=color:#f92672>,</span> name<span style=color:#f92672>)</span>
      <span style=color:#f92672>.</span><span style=color:#a6e22e>getResultList</span><span style=color:#f92672>();</span>

    <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</code></pre></div><p>就可以正常回傳 <code>Name</code> 和 <code>SeqNo</code>：</p><p><img src=../../img/blog/pYyd9s9.png alt></p><p>其實這件事也讓我在思考，使用像 H2 這樣的 Memory Database 雖然可以加速測試，但畢竟它和正式線上的資料庫不同，這樣的話這些測試是否能真實反映出實際的狀況呢?或者在 Unit Test 時直接使用如 DBUnit 這類的模擬假資料，反正使用 H2 模擬的也一樣只是假資料，而在 Integration Test 時使用和正式環境相同的資料庫這樣才更有意義也不一定?</p><p>如果有什麼想法或需要指正的地方，歡迎您留言或來信 😄</p></div><footer><div class=stats><ul class=categories><li><a class=article-terms-link href=/categories/note/>note</a></li></ul><ul class=tags><li><a class=article-terms-link href=/tags/backend/>backend</a></li><li><a class=article-terms-link href=/tags/java/>java</a></li><li><a class=article-terms-link href=/tags/database/>database</a></li></ul></div></footer></div><article class=post><div><h2 id=say-something>說些甚麼</h2><form id=comment-form class=new-comment method=post><h3 class="reply-notice hidden"><span class=reply-name></span></h3><input type=hidden name=options[entryId] value=91b2e4de389102cf3a644de520b8f56f>
<input type=hidden name=fields[replyThread]>
<input type=hidden name=fields[replyID]>
<input type=hidden name=fields[replyName]>
<input required name=fields[name] type=text placeholder=你的名字>
<input name=fields[email] type=email placeholder=你的郵件>
<textarea required name=fields[body] placeholder=你的信息 rows=10></textarea><div class=submit-notice><strong class="submit-notice-text submit-success hidden">感謝您的留言！ 審核後將會顯示在站上。</strong>
<strong class="submit-notice-text submit-failed hidden">抱歉，部份資料輸入有問題。請確認資料填寫正確後再試一次。</strong></div><input type=submit value=送出 class=button>
<input type=submit value=已送出 class="hidden button" disabled>
<input type=reset value=重設 class=button></form></div><div><h2>留言</h2></div></article></article><div class=pagination><a href=/blog/leetcode-104/ class="button left"><span>LeetCode 104. Maximum Depth of Binary Tree</span></a>
<a href=/blog/leetcode-55/ class="button right"><span>LeetCode 55. Jump Game</span></a></div></main><section id=site-sidebar><section id=recent-posts><header><h1>最新文章</h1></header><article class=mini-post><header><h2><a href=/blog/compartion-violation/>Java: Compartion Violation 問題小記</a></h2><time class=published datetime="2021-07-11 23:58:09 +0800 +0800">July 11, 2021</time></header></article><article class=mini-post><header><h2><a href=/blog/freemarker-json/>Use FreeMarker Template to Output JSON</a></h2><time class=published datetime="2021-07-06 01:28:39 +0800 +0800">July 6, 2021</time></header></article><article class=mini-post><header><h2><a href=/blog/leetcode-136/>Leetcode 136. Single Number</a></h2><time class=published datetime="2021-06-27 21:35:21 +0800 +0800">June 27, 2021</time></header></article><article class=mini-post><header><h2><a href=/blog/leetcode-104/>LeetCode 104. Maximum Depth of Binary Tree</a></h2><time class=published datetime="2021-06-09 01:14:14 +0800 +0800">June 9, 2021</time></header></article><article class=mini-post><header><h2><a href=/blog/sql-and-h2-db/>H2 Database and SQL Alias Column Name</a></h2><time class=published datetime="2021-06-08 07:59:46 +0800 +0800">June 8, 2021</time></header></article><footer><a href=/blog/ class=button>查看更多</a></footer></section><section id=categories><header><h1><a href=/categories>分類</a></h1></header><ul><li><a href=/categories/algorithm/>algorithm<span class=count>5</span></a><li><a href=/categories/note/>note<span class=count>4</span></a></li></ul></section><section id=mini-bio><header><h1>關於</h1></header><p>I'm so weak, so I learn from every master for things that I don't know</p><footer><a href=/about class=button>學到更多</a></footer></section></section><footer id=site-footer><ul class=socnet-icons><li><a href=//github.com/blackdiz target=_blank rel=noopener title=GitHub class="fab fa-github"></a></li><li><a href=mailto:blackdiz@gmail.com target=_blank title=Email class="far fa-envelope"></a></li></ul><p class=copyright>© 2021 Blackdiz's Garage<br>主題: <a href=https://themes.gohugo.io/hugo-future-imperfect-slim/ target=_blank rel=noopener>Hugo Future Imperfect Slim</a><br>移植自 <a href=https://html5up.net/future-imperfect target=_blank rel=noopener>HTML5 UP</a> | 由 <a href=https://gohugo.io/ target=_blank rel=noopener title=0.83.1>Hugo</a> 提供</p></footer><a id=back-to-top href=# class="fas fa-arrow-up fa-2x"></a><script src=/js/highlight.js></script><script>hljs.highlightAll()</script><script src=/js/bundle.min.35f126572987d033474497397ad93e095a2b5437f1c9509095557d756d3e6653.js integrity="sha256-NfEmVymH0DNHRJc5etk+CVorVDfxyVCQlVV9dW0+ZlM="></script><script src=/js/add-on.js></script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-79143868-1','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css integrity=sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.js integrity=sha384-YNHdsYkH6gMx9y3mRkmcJ2mFUjTd0qNQQvY9VYZgQd7DcN7env35GzlmFaZ23JGp crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous></script><script type=text/javascript>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:'$$',right:'$$',display:!0},{left:'$',right:'$',display:!1},{left:"\\begin{align}",right:"\\end{align}",display:!0}],throwOnError:!1})})</script></div></body></html>